# 学习笔记：RAG关键模块与向量数据库



## 第四章第一节：RAG的组件介绍

### 4.1.1 RAG 简介

**检索增强生成 (Retrieval-Augmented Generation, RAG)** 是一种旨在提升大型语言模型 (LLM) 准确性和可靠性的技术。

> **核心思想**：将LLM的通用知识（参数化知识）与从外部知识库检索到的具体、实时信息相结合。好比法官（LLM）需要书记员（RAG）去法律图书馆查找具体案例来做出更权威的判决。

**主要优势**:

- **提升可信度**：通过提供可引用的信息来源，用户可以验证答案，从而建立信任。
- **减少幻觉**：有效降低模型在不确定时“猜错”的可能性。
- **实现简单且经济**：相比于用新数据集重新训练模型，RAG的实现更快捷、成本更低（几行代码即可实现），并且可以随时更换知识源。
- **应用广泛**：可用于构建智能问答、客户服务、员工培训等系统，几乎任何企业都可以将内部文档转化为知识库来增强LLM的能力。

### 4.1.2 Loaders (加载器)

**Loaders** 是CAMEL框架中用于加载和预处理数据的核心模块，主要分为两大类。

1. **Base IO**:

   - **功能**: 专注于基础的文件输入/输出操作。

   - **核心**: 读取多种格式的文件（如PDF），提取内容并将其封装为专门的`File`对象，便于后续处理。

   - **示例代码**:

     ```python
     from io import BytesIO
     from camel.loaders import create_file_from_raw_bytes
     
     # 读取pdf文件
     with open("test.pdf", "rb") as file:
         file_content = file.read()
     
     # 根据文件扩展名创建对象
     file_obj = create_file_from_raw_bytes(file_content, "test.pdf")
     print(file_obj.docs[0]["page_content"])
     ```

2. **Unstructured IO**:

   - **功能**: 专注于非结构化数据的处理，具备强大的ETL（提取、转换、加载）能力。

   - **核心操作**:

     - **解析(Parse)**: 从文件或URL中加载并解析数据。
     - **清洗(Clean)**: 清理文本中的多余空格、非ASCII字符、Unicode引号等。
     - **提取(Extract)**: 从文本中抽取特定信息，如邮件地址。
     - **分块(Chunk)**: 将长文本按标题等规则切分成小块。
     - **暂存(Stage)**: 为不同平台准备数据元素。

   - **示例代码**:

     ```python
     from camel.loaders import UnstructuredIO
     uio = UnstructuredIO()
     
     # 示例1: 从URL解析数据
     example_url = ("https://hub.baai.ac.cn/view/41733")
     elements = uio.parse_file_or_url(example_url)
     print(("\n\n".join([str(el) for el in elements])))
     
     # 示例2: 清洗文本
     example_dirty_text = ("\x93Some dirty text â€™ with extra spaces and – dashes.")
     options = [('replace_unicode_quotes', {}), ('clean_dashes', {})]
     cleaned_text = uio.clean_text_data(text=example_dirty_text, clean_options=options)
     print(cleaned_text)
     # >>> Some dirty text with extra spaces and dashes.
     ```

### 4.1.3 Embeddings (嵌入)

**Embedding** 是将文本、图像等数据转换为机器能够理解的数值向量（Vector）的过程，这个向量能够捕捉数据的核心语义或特征。

1. **文本嵌入 (Text Embeddings)**:
   - **目的**: 将文本转化为代表其语义含义的向量，使得机器可以基于“意义”而非“字面”来比较文本。
   - **应用**: 语义搜索、问答系统、文本聚类等。
   - **常见技术**: `OpenAIEmbedding`, `SentenceTransformerEncoder`。
2. **图像嵌入 (Image Embeddings)**:
   - **目的**: 将图片转化为代表其视觉特征（形状、颜色、纹理）的向量。
   - **应用**: 图像分类、以图搜图、相似图片推荐等。
   - **常见技术**: 基于CNN（如ResNet）或Vision Transformer的模型。

**动手实践**: CAMEL框架提供了多种嵌入类，可以方便地生成嵌入向量。

- **`OpenAIEmbedding`**: 使用OpenAI模型生成文本嵌入。
- **`MistralEmbedding`**: 使用Mistral模型生成文本嵌入。
- **`SentenceTransformerEncoder`**: 使用本地Sentence Transformer模型，高效生成句子嵌入。
- **`VisionLanguageEmbedding`**: 基于多模态模型（如CLIP），可同时处理文本和图像。

```python
# 使用本地模型生成文本嵌入
from camel.embeddings import SentenceTransformerEncoder
sentence_encoder = SentenceTransformerEncoder(model_name='intfloat/e5-large-v2')
embeddings = sentence_encoder.embed_list(["Hello, world!", "Another example"])
```

### 4.1.4 Storages (存储)

**Storage** 模块负责数据的存储与管理，为RAG应用提供数据基础。

1. **键值存储 (Key-Value Storage)**:
   - 基于`BaseKeyValueStorage`抽象类。
   - `InMemoryKeyValueStorage`是其内存实现，适用于临时、易失性数据的存储，常用于开发和测试。
2. **向量存储 (Vector Storage)**:
   - **核心功能**: 存储高维向量数据，并支持高效的相似度搜索。是RAG检索功能的核心。
   - 基于`BaseVectorStorage`抽象类。
   - **具体实现**:
     - `MilvusStorage`: 对接Milvus向量数据库。
     - `QdrantStorage`: 对接Qdrant向量数据库。
3. **图存储 (Graph Storage)**:
   - 用于存储和查询图结构数据（节点和关系）。
   - 基于`BaseGraphStorage`抽象类。
   - **具体实现**:
     - `NebulaGraph`: 对接NebulaGraph图数据库。
     - `Neo4jGraph`: 对接Neo4j图数据库。

**动手实践 (QdrantStorage)**:

```python
from camel.storages import QdrantStorage, VectorDBQuery, VectorRecord

# 初始化一个4维的向量存储
qdrant_storage = QdrantStorage(vector_dim=4)

# 添加向量记录
qdrant_storage.add([
    VectorRecord(vector=[-0.1, 0.1, -0.1, 0.1], payload={'key1': 'value1'}),
    VectorRecord(vector=[-0.1, 0.1, 0.1, 0.1], payload={'key2': 'value2'}),
])

# 查询最相似的1个向量
query_results = qdrant_storage.query(VectorDBQuery(query_vector=[0.1, 0.2, 0.1, 0.1], top_k=1))

# 打印结果
for result in query_results:
    print(result.record.payload, result.similarity)
# >>> {'key2': 'value2'} 0.5669467095138407
```

### 4.1.5 Retrievers (检索器)

**Retrievers** 模块如同一个搜索引擎，用于从大量数据中高效查找所需信息。

1. **向量检索器 (Vector Retriever)**:
   - **原理**: 基于语义相似度进行检索。它将用户查询转换为向量，然后在向量存储中查找最相似的向量。
   - **优点**: 能理解自然语言的模糊关系，适合深度语义挖掘。
   - **流程**:
     1. 初始化`VectorRetriever`并指定嵌入模型和向量存储。
     2. 使用`.process()`方法加载、分块并嵌入数据，存入向量存储。
     3. 使用`.query()`方法执行语义查询。
2. **关键词检索器 (Keyword Retriever)**:
   - **原理**: 基于关键词的精确匹配。
   - **优点**: 速度快，适合查找特定术语。
3. **自动化检索 (AutoRetriever)**:
   - **功能**: 进一步简化流程，自动完成嵌入、存储和查询的完整任务，非常适合处理多个数据源。

```python
# AutoRetriever 示例
from camel.retrievers import AutoRetriever
from camel.embeddings import SentenceTransformerEncoder

ar = AutoRetriever(
    vector_storage_local_path="retrievers",
    embedding_model=SentenceTransformerEncoder(model_name='intfloat/e5-large-v2')
)

retrieved_info = ar.run_vector_retriever(
    contents=["https://www.camel-ai.org/"],
    query="What is CAMEL-AI"
)
print(retrieved_info)
```

## 第四章第二节：向量数据库介绍

**向量数据库 (Vector Database)** 是一种专门用于存储、管理和检索高维向量数据的数据库系统。

- **核心功能**:
  - **向量存储**: 高效存储海量高维向量及其关联的元数据。
  - **相似度搜索**: 通过**近似最近邻 (ANN)** 算法，极速找到与查询向量最相似的结果。
  - **高扩展性**: 可水平扩展以应对大规模数据。
- **常见应用**:
  - 推荐系统
  - 以图搜图、以视频搜视频
  - 自然语言处理（语义搜索、问答）
- **关键技术**:
  - **HNSW**: 基于图的高效ANN算法。
  - **LSH**: 基于哈希的快速检索算法。
  - **PQ**: 减少存储和计算成本的量化算法。
- **主流系统**:
  - **Milvus**: 开源向量数据库。
  - **Pinecone**: 向量数据库云服务。
  - **Weaviate**: 开源向量搜索引擎。

在**CAMEL框架**中，通过`camel.storages.vectordb_storages`包提供了对`Milvus`, `Qdrant`, `Weaviate`等多种主流向量数据库的无缝集成和支持。
